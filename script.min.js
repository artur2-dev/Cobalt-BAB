// Cobalt BAB main script (rebuilt)
(function() {
  let particlesLoaderPromise = null;

  // ===== Preloader =====
  document.addEventListener('DOMContentLoaded', () => {
    const preloader = document.querySelector('.preloader');
    const progressFill = document.querySelector('.progress-fill');
    const progressPercent = document.querySelector('.progress-percent');
    const startTime = performance.now();
    let finished = false;
    let siteStarted = false;
    let safetyTimer = 0;
    let finishTimer = 0;

    const startSiteOnce = () => {
      if (siteStarted) return;
      siteStarted = true;
      startSite();
    };

    const finish = () => {
      if (finished) return;
      finished = true;
      clearTimeout(safetyTimer);
      clearTimeout(finishTimer);
      if (!preloader) return startSiteOnce();
      preloader.classList.add('loaded');
      document.body.style.overflow = '';
      setTimeout(() => {
        preloader.style.display = 'none';
        startSiteOnce();
      }, 250);
    };

    if (!preloader) return startSiteOnce();

    document.body.style.overflow = 'hidden';
    let progress = 0;
    const tick = () => {
      progress = Math.min(100, progress + 5);
      if (progressFill) progressFill.style.width = progress + '%';
      if (progressPercent) progressPercent.textContent = Math.round(progress) + '%';
      if (progress < 95) setTimeout(tick, 80);
    };
    setTimeout(tick, 100);

    window.addEventListener('load', () => {
      if (progressFill) progressFill.style.width = '100%';
      if (progressPercent) progressPercent.textContent = '100%';
      const elapsed = performance.now() - startTime;
      const delay = elapsed > 1200 ? 150 : 400;
      finishTimer = setTimeout(finish, delay);
    }, { once: true });

    // На возврате из bfcache "load" может не сработать повторно
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) finish();
    }, { once: true });

    if (document.readyState === 'complete') {
      if (progressFill) progressFill.style.width = '100%';
      if (progressPercent) progressPercent.textContent = '100%';
      finishTimer = setTimeout(finish, 120);
    }

    safetyTimer = setTimeout(finish, 4000); // safety
  });

  // ===== Start site logic =====
  function startSite() {
    initializeSite();
  }

  // ===== Main site =====
  function initializeSite() {
    // Lazy images
    document.querySelectorAll('img').forEach(img => {
      if (!img.hasAttribute('loading')) img.setAttribute('loading', 'lazy');
    });

    const header = document.querySelector('header');
    const navLinks = Array.from(document.querySelectorAll('.nav-link'));
    const sections = Array.from(document.querySelectorAll('.section'));
    const hasHashNav = navLinks.some(link => (link.getAttribute('href') || '').startsWith('#'));

    initA11yEnhancements();
    syncActiveNavAria();
    initHeroParticles();

    // Для многостраничной версии: если на странице одна .section, показываем её сразу.
    if (sections.length === 1 && !sections[0].classList.contains('active')) {
      sections[0].classList.add('active');
    }

    // Mobile hamburger
    if (window.innerWidth <= 992) {
      const hamburger = document.createElement('button');
      hamburger.className = 'hamburger';
      hamburger.innerHTML = '<span></span><span></span><span></span>';
      hamburger.setAttribute('aria-label', 'Меню');
      hamburger.setAttribute('aria-expanded', 'false');
      const overlay = document.createElement('div');
      overlay.className = 'menu-overlay';
      const headerContainer = document.querySelector('header .container');
      const nav = document.querySelector('nav');
      if (headerContainer && nav) {
        const ctrl = document.createElement('div');
        ctrl.className = 'mobile-header-controls';
        ctrl.appendChild(hamburger);
        headerContainer.appendChild(ctrl);
        document.body.appendChild(overlay);
        const closeBtn = document.createElement('button');
        closeBtn.className = 'mobile-menu-close';
        closeBtn.innerHTML = '&times;';
        nav.prepend(closeBtn);
        const toggle = (open) => {
          const state = (typeof open === 'boolean') ? open : !nav.classList.contains('active');
          nav.classList.toggle('active', state);
          overlay.classList.toggle('active', state);
          hamburger.classList.toggle('active', state);
          document.body.classList.toggle('menu-open', state);
          hamburger.setAttribute('aria-expanded', state);
        };
        hamburger.addEventListener('click', e => { e.stopPropagation(); toggle(); });
        overlay.addEventListener('click', () => toggle(false));
        closeBtn.addEventListener('click', () => toggle(false));
        document.addEventListener('keydown', e => { if (e.key === 'Escape') toggle(false); });
        navLinks.forEach(l => l.addEventListener('click', () => toggle(false)));
      }
    }

    // Smooth scroll & nav active
    navLinks.forEach(link => {
      link.addEventListener('click', e => {
        const href = link.getAttribute('href') || '';
        if (!href.startsWith('#')) return;
        e.preventDefault();
        setActiveNav(href.substring(1));
      });
    });

    const setActiveNav = (id) => {
      if (hasHashNav) {
        navLinks.forEach(l => l.classList.remove('active'));
        const targetLink = document.querySelector(`.nav-link[href="#${id}"]`);
        if (targetLink) targetLink.classList.add('active');
      }
      syncActiveNavAria();
      sections.forEach(s => s.classList.toggle('active', s.id === id));
      const section = document.getElementById(id);
      if (section) {
        const top = section.offsetTop - (header ? header.offsetHeight + 10 : 0);
        window.scrollTo({ top, behavior: 'smooth' });
      }
    };

    const initialHash = window.location.hash.slice(1);
    if (initialHash && document.getElementById(initialHash)) setActiveNav(initialHash);
    window.addEventListener('hashchange', () => {
      const hash = window.location.hash.slice(1);
      if (hash && document.getElementById(hash)) setActiveNav(hash);
    });

    // Tabs: binds
    setupTabs('.category-tabs .tab-btn', '.bind-category', 'data-category');
    // Tabs: guides
    setupTabs('.guides-tabs .guide-tab-btn', '.guide-category', 'data-guide');
    // Filters + sort: bases
    setupBasesGrid();
    // Visual key chips for binds page
    decorateBindKeyChips();

    function initA11yEnhancements() {
      const main = document.querySelector('main');
      if (main && !main.id) main.id = 'main-content';

      if (main && !document.querySelector('.skip-link')) {
        const skipLink = document.createElement('a');
        skipLink.className = 'skip-link';
        skipLink.href = '#main-content';
        skipLink.textContent = 'Перейти к содержимому';
        document.body.prepend(skipLink);
      }

      const nav = document.querySelector('header nav');
      if (nav && !nav.getAttribute('aria-label')) {
        nav.setAttribute('aria-label', 'Основная навигация');
      }
    }

    function syncActiveNavAria() {
      navLinks.forEach((link) => {
        if (link.classList.contains('active')) {
          link.setAttribute('aria-current', 'page');
        } else {
          link.removeAttribute('aria-current');
        }
      });
    }

    function setupTabs(btnSelector, panelSelector, attr) {
      const buttons = Array.from(document.querySelectorAll(btnSelector));
      const panels = Array.from(document.querySelectorAll(panelSelector));
      if (!buttons.length || !panels.length) return;

      const tablist = buttons[0].parentElement;
      if (tablist && !tablist.hasAttribute('role')) tablist.setAttribute('role', 'tablist');

      const activate = (id, { focusButton = false } = {}) => {
        buttons.forEach((b) => {
          const selected = b.getAttribute(attr) === id;
          b.classList.toggle('active', selected);
          b.setAttribute('aria-selected', selected ? 'true' : 'false');
          b.setAttribute('tabindex', selected ? '0' : '-1');
          if (selected && focusButton) b.focus();
        });

        panels.forEach((p) => {
          const isActive = p.id === id;
          p.classList.toggle('active', isActive);
          p.setAttribute('aria-hidden', isActive ? 'false' : 'true');
          p.toggleAttribute('hidden', !isActive);
        });
      };

      buttons.forEach((btn, index) => {
        const id = btn.getAttribute(attr);
        if (!id) return;

        const panel = panels.find((p) => p.id === id);
        const tabId = `${id}-tab`;

        btn.id = tabId;
        btn.setAttribute('role', 'tab');
        btn.setAttribute('aria-controls', id);

        if (panel) {
          panel.setAttribute('role', 'tabpanel');
          panel.setAttribute('aria-labelledby', tabId);
        }

        btn.addEventListener('click', () => activate(id));
        btn.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
            event.preventDefault();
            const dir = event.key === 'ArrowRight' ? 1 : -1;
            const nextIndex = (index + dir + buttons.length) % buttons.length;
            const nextId = buttons[nextIndex].getAttribute(attr);
            if (nextId) activate(nextId, { focusButton: true });
            return;
          }
          if (event.key === 'Home') {
            event.preventDefault();
            const firstId = buttons[0].getAttribute(attr);
            if (firstId) activate(firstId, { focusButton: true });
            return;
          }
          if (event.key === 'End') {
            event.preventDefault();
            const lastId = buttons[buttons.length - 1].getAttribute(attr);
            if (lastId) activate(lastId, { focusButton: true });
          }
        });
      });

      const initial = buttons.find((b) => b.classList.contains('active')) || buttons[0];
      const initialId = initial.getAttribute(attr);
      if (initialId) activate(initialId);
    }

    function decorateBindKeyChips() {
      if (!document.body || document.body.getAttribute('data-page') !== 'binds') return;
      const bindKeyRows = document.querySelectorAll('#binds .bind-key');
      if (!bindKeyRows.length) return;

      const keyTokenRegex = /\b(F\d{1,2}|MOUSE\d|ПКМ|ЛКМ|КОЛ[ЕЁ]СИКО|[A-ZА-ЯЁ]|\d)\b/gi;
      const normalizeChip = (token) => {
        const upper = token.toUpperCase().replace('Ё', 'Е');
        if (upper === 'ПКМ') return 'RMB';
        if (upper === 'ЛКМ') return 'LMB';
        if (upper === 'КОЛЕСИКО') return 'MOUSE3';
        return upper;
      };

      bindKeyRows.forEach((row) => {
        if (row.dataset.keysDecorated === 'true') return;
        row.dataset.keysDecorated = 'true';

        const icon = row.querySelector('i');
        const iconHTML = icon ? icon.outerHTML : '<i class="fas fa-keyboard"></i>';
        const originalText = (row.textContent || '').replace(/\s+/g, ' ').trim();
        const keyText = originalText.replace(/^Клавиша:\s*/i, '').trim();
        if (!keyText) return;

        let chipCount = 0;
        const decorated = keyText.replace(keyTokenRegex, (match) => {
          chipCount += 1;
          return `<span class="key-chip">${normalizeChip(match)}</span>`;
        });

        const fallbackChip = chipCount === 0 && /консоль/i.test(keyText)
          ? ' <span class="key-chip">F1</span>'
          : '';

        row.innerHTML = `${iconHTML}<span class="key-line">${decorated}${fallbackChip}</span>`;
      });
    }

    // Copy buttons
    const copyBtns = document.querySelectorAll('.copy-btn');
    const copyNotification = document.getElementById('copyNotification');
    let notifyTimer;
    const showToast = (text, error) => {
      if (!copyNotification) return;
      copyNotification.textContent = text;
      copyNotification.style.background = error ? 'linear-gradient(135deg,#e74c3c,#c0392b)' : 'var(--gradient-primary)';
      copyNotification.classList.remove('show');
      void copyNotification.offsetWidth;
      copyNotification.classList.add('show');
      clearTimeout(notifyTimer);
      notifyTimer = setTimeout(()=>copyNotification.classList.remove('show'), 2000);
    };
    copyBtns.forEach(btn => {
      btn.addEventListener('click', async e => {
        e.preventDefault();
        const txt = btn.getAttribute('data-clipboard-text') || btn.textContent;
        btn.classList.add('copied');
        const prev = btn.innerHTML;
        try {
          await navigator.clipboard.writeText(txt);
          btn.innerHTML = "<i class='fas fa-check'></i> Скопировано";
          showToast('Скопировано в буфер!');
        } catch(err) {
          btn.innerHTML = "<i class='fas fa-times'></i> Ошибка";
          showToast('Не удалось скопировать', true);
        }
        setTimeout(()=>{ btn.classList.remove('copied'); btn.innerHTML = prev; }, 900);
      });
    });

    // FAQ accordion + filters
    const faqItems = document.querySelectorAll('.faq-item');
    const faqSearch = document.getElementById('faqSearch');
    const faqNoResults = document.querySelector('.faq-no-results');
    const faqFilterBtns = document.querySelectorAll('.faq-filter-btn');

    faqItems.forEach((item, index) => {
      const header = item.querySelector('.faq-header');
      const content = item.querySelector('.faq-content');
      if (!header || !content) return;

      const panelId = content.id || `faq-panel-${index + 1}`;
      const triggerId = header.id || `faq-trigger-${index + 1}`;

      content.id = panelId;
      content.hidden = true;
      content.setAttribute('role', 'region');
      content.setAttribute('aria-labelledby', triggerId);

      header.id = triggerId;
      header.setAttribute('role', 'button');
      header.setAttribute('tabindex', '0');
      header.setAttribute('aria-controls', panelId);
      header.setAttribute('aria-expanded', 'false');

      const activate = () => toggleFAQ(item, content);
      header.addEventListener('click', activate);
      header.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          activate();
        }
      });
    });
    function toggleFAQ(item, content){
      const isOpen = item.classList.contains('active');
      faqItems.forEach(i=>{
        i.classList.remove('active');
        const h = i.querySelector('.faq-header');
        const c = i.querySelector('.faq-content');
        if (h) h.setAttribute('aria-expanded', 'false');
        if (c) {
          c.style.maxHeight = '0px';
          c.hidden = true;
        }
      });
      if (!isOpen){
        item.classList.add('active');
        const header = item.querySelector('.faq-header');
        if (header) header.setAttribute('aria-expanded', 'true');
        content.hidden = false;
        content.style.maxHeight = content.scrollHeight + 'px';
      }
    }

    function initHeroParticles() {
      const container = document.getElementById('particles-js');
      if (!container) return;

      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        container.style.display = 'none';
        return;
      }

      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const config = {
        particles: {
          number: {
            value: isMobile ? 28 : 54,
            density: { enable: true, value_area: 900 }
          },
          color: { value: ['#00d4ff', '#3498db', '#8be9ff'] },
          shape: { type: 'circle' },
          opacity: { value: 0.42, random: true },
          size: { value: 3, random: true },
          line_linked: {
            enable: true,
            distance: 140,
            color: '#00d4ff',
            opacity: 0.2,
            width: 1
          },
          move: {
            enable: true,
            speed: isMobile ? 1.3 : 2,
            direction: 'none',
            random: true,
            straight: false,
            out_mode: 'out',
            bounce: false
          }
        },
        interactivity: {
          detect_on: 'canvas',
          events: {
            onhover: { enable: true, mode: 'grab' },
            onclick: { enable: true, mode: 'push' },
            resize: true
          },
          modes: {
            grab: { distance: 140, line_linked: { opacity: 0.35 } },
            push: { particles_nb: 3 }
          }
        },
        retina_detect: true
      };

      const startParticles = () => {
        if (typeof window.particlesJS !== 'function') return;
        container.innerHTML = '';
        window.particlesJS('particles-js', config);
      };

      if (typeof window.particlesJS === 'function') {
        startParticles();
        return;
      }

      loadParticlesLibrary().then((loaded) => {
        if (!loaded) return;
        startParticles();
      });
    }

    function loadParticlesLibrary() {
      if (typeof window.particlesJS === 'function') return Promise.resolve(true);
      if (particlesLoaderPromise) return particlesLoaderPromise;

      particlesLoaderPromise = new Promise((resolve) => {
        const existing = document.querySelector('script[data-particles-js="true"]');
        if (existing) {
          existing.addEventListener('load', () => resolve(true), { once: true });
          existing.addEventListener('error', () => resolve(false), { once: true });
          return;
        }

        const script = document.createElement('script');
        script.src = 'assets/js/particles.min.js';
        script.async = true;
        script.defer = true;
        script.setAttribute('data-particles-js', 'true');
        script.addEventListener('load', () => resolve(true), { once: true });
        script.addEventListener('error', () => resolve(false), { once: true });
        document.head.appendChild(script);
      });

      return particlesLoaderPromise;
    }

    function setupBasesGrid() {
      const filterBtns = Array.from(document.querySelectorAll('.bases-filters .filter-btn'));
      const sortSelect = document.querySelector('.bases-sort .sort-select');
      const grid = document.querySelector('.bases-grid');
      const cards = Array.from(document.querySelectorAll('.bases-grid .base-card'));

      if (!grid || !cards.length) return;

      const originalIndex = new Map(cards.map((card, idx) => [card, idx]));
      const costRank = { low: 1, medium: 2, high: 3 };
      let currentFilter = 'all';

      const getCardRating = (card) => {
        const ratingStat = Array.from(card.querySelectorAll('.base-stats .stat'))
          .find((el) => el.textContent.includes('/10'));
        if (!ratingStat) return 0;
        const text = ratingStat.textContent.trim();
        const value = parseFloat(text.split('/')[0].replace(',', '.'));
        return Number.isFinite(value) ? value : 0;
      };

      const getCardArea = (card) => {
        const size = (card.getAttribute('data-size') || '').toLowerCase();
        const parts = size.split('x').map((n) => parseInt(n, 10));
        if (parts.length !== 2 || Number.isNaN(parts[0]) || Number.isNaN(parts[1])) return 0;
        return parts[0] * parts[1];
      };

      const applyFilter = () => {
        cards.forEach((card) => {
          const category = card.getAttribute('data-category') || '';
          const visible = currentFilter === 'all' || category === currentFilter;
          card.style.display = visible ? '' : 'none';
        });
      };

      const applySort = () => {
        const sortMode = sortSelect ? sortSelect.value : 'newest';
        const sorted = [...cards].sort((a, b) => {
          if (sortMode === 'popular') {
            return getCardRating(b) - getCardRating(a);
          }
          if (sortMode === 'size') {
            return getCardArea(b) - getCardArea(a);
          }
          if (sortMode === 'cost') {
            const aCost = costRank[a.getAttribute('data-cost')] || 999;
            const bCost = costRank[b.getAttribute('data-cost')] || 999;
            return aCost - bCost;
          }
          // newest: keep original order from HTML
          return (originalIndex.get(a) || 0) - (originalIndex.get(b) || 0);
        });

        sorted.forEach((card) => grid.appendChild(card));
      };

      const render = () => {
        applySort();
        applyFilter();
      };

      filterBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          currentFilter = btn.getAttribute('data-filter') || 'all';
          filterBtns.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          render();
        });
      });

      if (sortSelect) {
        sortSelect.addEventListener('change', render);
      }

      render();
    }
    faqFilterBtns.forEach(btn => btn.addEventListener('click', ()=>{
      const cat = btn.getAttribute('data-category');
      faqFilterBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const searchTerm = faqSearch ? faqSearch.value : '';
      filterFAQ(cat, searchTerm);
    }));
    if (faqSearch) faqSearch.addEventListener('input', ()=>{
      const activeBtn = document.querySelector('.faq-filter-btn.active');
      const cat = (activeBtn && activeBtn.getAttribute('data-category')) || 'all';
      filterFAQ(cat, faqSearch.value);
    });
    function filterFAQ(cat, term){
      term = term.toLowerCase();
      let visible=0;
      faqItems.forEach(item=>{
        const matchesCat = cat==='all' || item.getAttribute('data-category')===cat;
        const text = item.textContent.toLowerCase();
        const match = matchesCat && text.includes(term);
        item.classList.toggle('hidden', !match);
        if(match) visible++;
      });
      if (faqNoResults) faqNoResults.style.display = visible? 'none':'block';
    }

    // Discord counts
    const onlineEls = document.querySelectorAll('.discord-online, #discordOnline');
    const memberEls = document.querySelectorAll('.discord-members, #discordMembers');
    if (onlineEls.length || memberEls.length){
      const url = 'https://discord.com/api/v9/invites/Q8ZfawakxS?with_counts=true&with_expiration=true';
      const update = async ()=>{
        try {
          const res = await fetch(url, {cache:'no-store'});
          if(!res.ok) throw new Error(res.statusText);
          const data = await res.json();
          const online = data.approximate_presence_count;
          const members = data.approximate_member_count;
          if(online!==undefined) onlineEls.forEach(el=>el.textContent=online);
          if(members!==undefined) memberEls.forEach(el=>el.textContent=members);
        } catch(err){
          onlineEls.forEach(el=>el.textContent='—');
          memberEls.forEach(el=>el.textContent='—');
        }
      };
      update();
      setInterval(update,120000);
    }

    // Parallax glow
    const canHoverParallax = window.matchMedia('(hover: hover) and (pointer: fine)').matches;
    if (canHoverParallax) {
      const parallaxCards = document.querySelectorAll('.bind-card, .guide-card, .faq-item, .feature-card, .base-card');
      parallaxCards.forEach(card => {
        card.classList.add('parallax-card');
        card.addEventListener('mousemove', e => {
          const r = card.getBoundingClientRect();
          const x = e.clientX - r.left;
          const y = e.clientY - r.top;
          const tiltX = ((y/r.height)-0.5)*-6;
          const tiltY = ((x/r.width)-0.5)*8;
          card.style.setProperty('--tiltX', `${tiltX}deg`);
          card.style.setProperty('--tiltY', `${tiltY}deg`);
          card.style.setProperty('--glowX', `${x}px`);
          card.style.setProperty('--glowY', `${y}px`);
        });
        card.addEventListener('mouseleave', ()=>{
          card.style.removeProperty('--tiltX');
          card.style.removeProperty('--tiltY');
          card.style.removeProperty('--glowX');
          card.style.removeProperty('--glowY');
          card.style.transform = '';
        });
      });
    }

    // Scroll to top button
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    if (scrollTopBtn){
      window.addEventListener('scroll', ()=>{
        scrollTopBtn.style.display = window.scrollY > 400 ? 'block' : 'none';
      }, { passive: true });
      scrollTopBtn.addEventListener('click', ()=>{
        window.scrollTo({top:0, behavior:'smooth'});
      });
    }

    console.log('✓ Cobalt BAB инициализирован.');
  }
})();
